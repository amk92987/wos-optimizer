"""
Build Buildings edges from raw data.
Generates upgrade edges for all buildings L1-L30 with costs and prerequisites.
"""

import json
from pathlib import Path
from datetime import datetime, timezone

# Paths
PROJECT_ROOT = Path(__file__).parent.parent
RAW_FILE = PROJECT_ROOT / "data" / "raw" / "buildings.samples.json"
EDGES_FILE = PROJECT_ROOT / "data" / "upgrades" / "buildings.edges.json"
REPORT_FILE = PROJECT_ROOT / "data" / "validation" / "buildings.report.json"

# Helper to parse time strings to seconds
def parse_time(time_str: str) -> int:
    """Convert time string like '1d 4h 30m' to seconds."""
    if not time_str or time_str == "N/A" or time_str == "â€”":
        return 0

    total_seconds = 0
    time_str = time_str.strip()

    # Handle days
    if 'd' in time_str:
        parts = time_str.split('d')
        total_seconds += int(parts[0].strip()) * 86400
        time_str = parts[1].strip() if len(parts) > 1 else ""

    # Handle hours
    if 'h' in time_str:
        parts = time_str.split('h')
        total_seconds += int(parts[0].strip()) * 3600
        time_str = parts[1].strip() if len(parts) > 1 else ""

    # Handle minutes
    if 'm' in time_str:
        parts = time_str.split('m')
        mins = parts[0].strip()
        if mins:
            total_seconds += int(mins) * 60
        time_str = parts[1].strip() if len(parts) > 1 else ""

    # Handle seconds
    if 's' in time_str:
        secs = time_str.replace('s', '').strip()
        if secs:
            total_seconds += int(secs)

    return total_seconds


# Raw building data (extracted from whiteoutdata.com)
# Format: [level, wood, meat, coal, iron, time_str, furnace_prereq]
# 0 = N/A for that resource

BUILDINGS_DATA = {
    "furnace": {
        "prereqs_type": "custom",  # Has various prereqs
        "levels": [
            # [lvl, wood, meat, coal, iron, time, power]
            [1, 2000, 0, 0, 0, "0s", 2000],
            [2, 180, 0, 0, 0, "6s", 3800],
            [3, 805, 0, 0, 0, "1m", 6500],
            [4, 1800, 0, 360, 0, "3m", 10100],
            [5, 7600, 0, 1500, 0, "10m", 15500],
            [6, 19000, 0, 3800, 960, "30m", 23600],
            [7, 69000, 0, 13000, 3400, "1h", 35300],
            [8, 120000, 0, 25000, 6300, "2h 30m", 47000],
            [9, 260000, 0, 52000, 13000, "4h 30m", 58700],
            [10, 460000, 0, 92000, 23000, "6h", 75700],
            [11, 1300000, 1300000, 260000, 65000, "7h 30m", 92700],
            [12, 1600000, 1600000, 330000, 84000, "9h", 109700],
            [13, 2300000, 2300000, 470000, 110000, "11h", 138400],
            [14, 3100000, 3100000, 630000, 150000, "14h", 167100],
            [15, 4600000, 4600000, 930000, 230000, "18h", 195800],
            [16, 5900000, 5900000, 1100000, 290000, "1d 6h 28m", 236200],
            [17, 9300000, 9300000, 1800000, 460000, "1d 12h 34m", 276600],
            [18, 12000000, 12000000, 2500000, 620000, "1d 19h 53m", 317000],
            [19, 15000000, 15000000, 3100000, 780000, "2d 17h 50m", 374400],
            [20, 21000000, 21000000, 4300000, 1000000, "3d 10h 18m", 431800],
            [21, 27000000, 27000000, 5400000, 1300000, "4d 10h 59m", 489200],
            [22, 36000000, 36000000, 7200000, 1800000, "6d 16h 29m", 575300],
            [23, 44000000, 44000000, 8900000, 2200000, "9d 8h 40m", 661400],
            [24, 60000000, 60000000, 12000000, 3000000, "13d 2h 33m", 747500],
            [25, 81000000, 81000000, 16000000, 4000000, "18d 8h 22m", 833600],
            [26, 100000000, 100000000, 21000000, 5200000, "21d 2h 26m", 960100],
            [27, 140000000, 140000000, 24000000, 7400000, "25d 7h 43m", 1086600],
            [28, 190000000, 190000000, 39000000, 9900000, "29d 2h 52m", 1213100],
            [29, 240000000, 240000000, 49000000, 12000000, "33d 11h 42m", 1339600],
            [30, 300000000, 300000000, 60000000, 15000000, "40d 4h 27m", 1523500],
        ]
    },
    "embassy": {
        "prereqs_type": "furnace",
        "levels": [
            [1, 60, 0, 0, 0, "2s", 0],
            [2, 90, 0, 0, 0, "10s", 0],
            [3, 400, 0, 0, 0, "1m", 0],
            [4, 900, 180, 0, 0, "2m", 0],
            [5, 3800, 760, 0, 0, "6m 40s", 0],
            [6, 9600, 1900, 480, 0, "13m 20s", 0],
            [7, 34000, 6900, 1700, 0, "25m", 0],
            [8, 63000, 12000, 3100, 0, "45m", 0],
            [9, 130000, 26000, 6500, 0, "2h", 0],
            [10, 230000, 46000, 11000, 0, "3h 57m 30s", 0],
            [11, 260000, 52000, 13000, 260000, "4h 57m", 0],
            [12, 330000, 67000, 16000, 330000, "5h 56m", 0],
            [13, 470000, 95000, 23000, 470000, "7h 15m 30s", 0],
            [14, 630000, 120000, 31000, 630000, "9h 14m", 0],
            [15, 930000, 180000, 46000, 930000, "11h 52m 30s", 0],
            [16, 1100000, 230000, 59000, 1100000, "19h 43m 20s", 0],
            [17, 1800000, 370000, 93000, 1800000, "1d 8m", 0],
            [18, 2500000, 500000, 120000, 2500000, "1d 4h 58m", 0],
            [19, 3100000, 620000, 150000, 3100000, "1d 19h 27m", 0],
            [20, 4300000, 860000, 210000, 4300000, "2d 6h 19m", 0],
            [21, 5400000, 1000000, 270000, 5400000, "2d 22h 36m", 0],
            [22, 7200000, 1400000, 360000, 7200000, "4d 9h 55m", 0],
            [23, 8900000, 1700000, 440000, 8900000, "6d 4h 17m", 0],
            [24, 12000000, 2400000, 600000, 12000000, "8d 15h 36m", 0],
            [25, 16000000, 3200000, 810000, 16000000, "12d 2h 38m", 0],
            [26, 21000000, 4200000, 1000000, 21000000, "13d 22h 14m", 0],
            [27, 29000000, 5900000, 1400000, 29000000, "16d 17h 5m", 0],
            [28, 39000000, 7900000, 1900000, 39000000, "19d 5h 15m", 0],
            [29, 49000000, 9800000, 2400000, 49000000, "22d 2h 26m", 0],
            [30, 60000000, 12000000, 3000000, 60000000, "26d 12h 32m", 0],
        ]
    },
    "infantry_camp": {
        "prereqs_type": "furnace",
        "levels": [
            [1, 0, 0, 0, 0, "2s", 0],
            [2, 140, 0, 0, 0, "9s", 0],
            [3, 645, 0, 0, 0, "45s", 0],
            [4, 1400, 0, 285, 0, "2m 5s", 0],
            [5, 6000, 0, 1200, 0, "4m 30s", 0],
            [6, 15000, 0, 3000, 765, "9m", 0],
            [7, 55000, 0, 11000, 2700, "18m", 0],
            [8, 100000, 0, 20000, 5000, "27m", 0],
            [9, 200000, 0, 41000, 10000, "40m 30s", 0],
            [10, 360000, 0, 73000, 18000, "54m", 0],
            [11, 460000, 460000, 92000, 23000, "1h 7m 30s", 0],
            [12, 580000, 580000, 110000, 29000, "1h 21m", 0],
            [13, 830000, 830000, 160000, 41000, "1h 39m", 0],
            [14, 1100000, 1100000, 220000, 55000, "2h 6m", 0],
            [15, 1600000, 1600000, 320000, 81000, "2h 42m", 0],
            [16, 2000000, 2000000, 410000, 100000, "4h 34m", 0],
            [17, 3200000, 3200000, 650000, 160000, "5h 29m", 0],
            [18, 4300000, 4300000, 870000, 210000, "6h 35m", 0],
            [19, 5400000, 5400000, 1000000, 270000, "9h 52m", 0],
            [20, 7500000, 7500000, 1500000, 370000, "12h 20m 30s", 0],
            [21, 9500000, 9500000, 1900000, 470000, "16h 2m 30s", 0],
            [22, 12000000, 12000000, 2500000, 630000, "1d 4m", 0],
            [23, 15000000, 15000000, 3100000, 780000, "1d 9h 42m", 0],
            [24, 21000000, 21000000, 4200000, 1000000, "1d 23h 11m", 0],
            [25, 28000000, 28000000, 5700000, 1400000, "2d 18h 3m", 0],
            [26, 36000000, 36000000, 7300000, 1800000, "3d 3h 57m", 0],
            [27, 52000000, 52000000, 10000000, 2600000, "3d 19h 9m", 0],
            [28, 69000000, 69000000, 13000000, 3400000, "4d 8h 49m", 0],
            [29, 86000000, 86000000, 17000000, 4300000, "5d 33m", 0],
            [30, 100000000, 100000000, 21000000, 5800000, "6d 40m", 0],
        ]
    },
    "lancer_camp": {
        "prereqs_type": "furnace",
        "levels": [
            [1, 0, 0, 0, 0, "2s", 0],
            [2, 140, 0, 0, 0, "9s", 0],
            [3, 645, 0, 0, 0, "45s", 0],
            [4, 1400, 0, 285, 0, "2m 15s", 0],
            [5, 6000, 0, 1200, 0, "4m 30s", 0],
            [6, 15000, 0, 3000, 765, "9m", 0],
            [7, 55000, 0, 11000, 2700, "18m", 0],
            [8, 100000, 0, 20000, 5000, "27m", 0],
            [9, 200000, 0, 41000, 10000, "40m 30s", 0],
            [10, 360000, 0, 73000, 18000, "54m", 0],
            [11, 460000, 460000, 92000, 23000, "1h 7m 30s", 0],
            [12, 580000, 580000, 110000, 29000, "1h 21m", 0],
            [13, 830000, 830000, 160000, 41000, "1h 39m", 0],
            [14, 1100000, 1100000, 220000, 55000, "2h 6m", 0],
            [15, 1600000, 1600000, 320000, 81000, "2h 42m", 0],
            [16, 2000000, 2000000, 410000, 100000, "4h 34m", 0],
            [17, 3200000, 3200000, 650000, 160000, "5h 29m", 0],
            [18, 4300000, 4300000, 870000, 210000, "6h 35m", 0],
            [19, 5400000, 5400000, 1000000, 270000, "9h 52m 30s", 0],
            [20, 7500000, 7500000, 1500000, 370000, "12h 20m 30s", 0],
            [21, 9500000, 9500000, 1900000, 470000, "16h 2m 30s", 0],
            [22, 12000000, 12000000, 2500000, 630000, "1d 4m", 0],
            [23, 15000000, 15000000, 3100000, 780000, "1d 9h 42m", 0],
            [24, 21000000, 21000000, 4200000, 1000000, "1d 23h 11m", 0],
            [25, 28000000, 28000000, 5700000, 1400000, "2d 18h 3m", 0],
            [26, 36000000, 36000000, 7300000, 1800000, "3d 3h 57m", 0],
            [27, 52000000, 52000000, 10000000, 2600000, "3d 19h 9m", 0],
            [28, 69000000, 69000000, 13000000, 3400000, "4d 8h 49m", 0],
            [29, 86000000, 86000000, 17000000, 4300000, "5d 33m", 0],
            [30, 100000000, 100000000, 21000000, 5200000, "6d 40m", 0],
        ]
    },
    "marksman_camp": {
        "prereqs_type": "furnace",
        "levels": [
            [1, 0, 0, 0, 0, "2s", 0],
            [2, 140, 0, 0, 0, "9s", 0],
            [3, 645, 0, 0, 0, "45s", 0],
            [4, 1400, 0, 285, 0, "2m 5s", 0],
            [5, 6000, 0, 1200, 0, "4m 30s", 0],
            [6, 15000, 0, 3000, 765, "9m", 0],
            [7, 55000, 0, 11000, 2700, "18m", 0],
            [8, 100000, 0, 20000, 5000, "27m", 0],
            [9, 200000, 0, 41000, 10000, "40m 30s", 0],
            [10, 360000, 0, 73000, 18000, "54m", 0],
            [11, 460000, 460000, 92000, 23000, "1h 7m 30s", 0],
            [12, 580000, 580000, 110000, 29000, "1h 21m", 0],
            [13, 830000, 830000, 160000, 41000, "1h 39m", 0],
            [14, 1100000, 1100000, 220000, 55000, "2h 6m", 0],
            [15, 1600000, 1600000, 320000, 81000, "2h 42m", 0],
            [16, 2000000, 2000000, 410000, 100000, "4h 34m", 0],
            [17, 3200000, 3200000, 650000, 160000, "5h 29m", 0],
            [18, 4300000, 4300000, 870000, 210000, "6h 35m", 0],
            [19, 5400000, 5400000, 1000000, 270000, "9h 52m", 0],
            [20, 7500000, 7500000, 1500000, 370000, "12h 20m 30s", 0],
            [21, 9500000, 9500000, 1900000, 470000, "16h 2m 30s", 0],
            [22, 12000000, 12000000, 2500000, 630000, "1d 4m", 0],
            [23, 15000000, 15000000, 3100000, 780000, "1d 9h 42m", 0],
            [24, 21000000, 21000000, 4200000, 1000000, "1d 23h 11m", 0],
            [25, 28000000, 28000000, 5700000, 1400000, "2d 18h 3m", 0],
            [26, 36000000, 36000000, 7300000, 1800000, "3d 3h 57m", 0],
            [27, 52000000, 52000000, 10000000, 2600000, "3d 19h 9m", 0],
            [28, 69000000, 69000000, 13000000, 3400000, "4d 8h 49m", 0],
            [29, 86000000, 86000000, 17000000, 4300000, "5d 33m", 0],
            [30, 100000000, 100000000, 21000000, 5800000, "6d 40m", 0],
        ]
    },
    "research_center": {
        "prereqs_type": "furnace",
        "levels": [
            [1, 105, 0, 0, 0, "2s", 0],
            [2, 160, 0, 0, 0, "9s", 0],
            [3, 725, 0, 0, 0, "45s", 0],
            [4, 1600, 0, 320, 0, "2m 15s", 0],
            [5, 6800, 0, 1300, 0, "4m 30s", 0],
            [6, 17000, 0, 3400, 860, "9m", 0],
            [7, 62000, 0, 12000, 3100, "18m", 0],
            [8, 110000, 0, 22000, 5600, "27m", 0],
            [9, 230000, 0, 47000, 11000, "40m 30s", 0],
            [10, 410000, 0, 82000, 20000, "54m", 0],
            [11, 520000, 520000, 100000, 26000, "1h 7m 30s", 0],
            [12, 670000, 670000, 130000, 33000, "1h 21m", 0],
            [13, 950000, 950000, 190000, 47000, "1h 39m", 0],
            [14, 1200000, 1200000, 250000, 63000, "2h 6m", 0],
            [15, 1800000, 1800000, 370000, 93000, "2h 42m", 0],
            [16, 2300000, 2300000, 470000, 110000, "4h 34m", 0],
            [17, 3700000, 3700000, 740000, 180000, "5h 29m", 0],
            [18, 5000000, 5000000, 1000000, 250000, "6h 35m", 0],
            [19, 6200000, 6200000, 1200000, 310000, "9h 52m", 0],
            [20, 8600000, 8600000, 1700000, 430000, "12h 20m 30s", 0],
            [21, 10000000, 10000000, 2100000, 540000, "16h 2m 30s", 0],
            [22, 14000000, 14000000, 2800000, 720000, "1d 4m", 0],
            [23, 17000000, 17000000, 3500000, 890000, "1d 9h 42m", 0],
            [24, 24000000, 24000000, 4800000, 1200000, "1d 23h 11m", 0],
            [25, 32000000, 32000000, 6500000, 1600000, "2d 18h 3m", 0],
            [26, 42000000, 42000000, 8400000, 2100000, "3d 3h 57m", 0],
            [27, 59000000, 59000000, 11000000, 2900000, "3d 19h 9m", 0],
            [28, 79000000, 79000000, 15000000, 3900000, "4d 8h 49m", 0],
            [29, 98000000, 98000000, 19000000, 4900000, "5d 33m", 0],
            [30, 120000000, 120000000, 24000000, 6000000, "6d 40m", 0],
        ]
    },
    "command_center": {
        "prereqs_type": "furnace",
        "levels": [
            [1, 1500, 400, 80, 0, "2s", 0],
            [2, 3500, 700, 125, 0, "8s", 0],
            [3, 5700, 1000, 565, 0, "35s", 0],
            [4, 8000, 1400, 1200, 0, "1m 45s", 0],
            [5, 11500, 1800, 5300, 0, "3m 35s", 0],
            [6, 15000, 2800, 13000, 670, "7m 10s", 0],
            [7, 19000, 3800, 48000, 2400, "14m", 0],
            [8, 24000, 5000, 88000, 4400, "21m 30s", 0],
            [9, 29500, 6500, 180000, 9100, "32m", 0],
            [10, 35500, 8000, 320000, 16000, "43m", 0],
            [11, 43500, 10500, 390000, 19000, "54m", 0],
            [12, 52000, 13000, 500000, 25000, "1h 4m 30s", 0],
            [13, 62000, 16000, 710000, 35000, "1h 19m", 0],
            [14, 73500, 19000, 940000, 47000, "1h 40m 30s", 0],
            [15, 87500, 22000, 1300000, 69000, "2h 9m 30s", 0],
            [16, 105000, 27000, 1700000, 89000, "3h 39m", 0],
            [17, 120000, 32000, 2700000, 130000, "4h 23m", 0],
            [18, 140000, 34000, 3700000, 180000, "5h 16m", 0],
            [19, 165000, 36000, 4700000, 230000, "7h 54m", 0],
            [20, 195000, 38000, 6400000, 320000, "9h 52m", 0],
            [21, 225000, 40500, 8100000, 400000, "12h 50m", 0],
            [22, 260000, 43000, 10000000, 540000, "19h 15m 30s", 0],
            [23, 305000, 46000, 13000000, 670000, "1d 2h 57m", 0],
            [24, 350000, 48500, 18000000, 900000, "1d 13h 44m", 0],
            [25, 400000, 52000, 24000000, 1200000, "2d 4h 50m", 0],
            [26, 470000, 54500, 31000000, 1500000, "2d 12h 46m", 0],
            [27, 550000, 57000, 44000000, 2200000, "3d 55m", 0],
            [28, 630000, 60500, 59000000, 2900000, "3d 11h 51m", 0],
            [29, 725000, 64000, 73000000, 3600000, "4d 26m", 0],
            [30, 840000, 67000, 90000000, 4500000, "4d 19h 44m", 0],
        ]
    },
    "infirmary": {
        "prereqs_type": "furnace",
        "levels": [
            [1, 200, 0, 0, 0, "2s", 0],
            [2, 100, 0, 0, 0, "9s", 0],
            [3, 460, 0, 0, 0, "40s", 0],
            [4, 1000, 0, 205, 0, "2m 5s", 0],
            [5, 4300, 0, 865, 0, "4m 10s", 0],
            [6, 10000, 0, 2100, 545, "8m 20s", 0],
            [7, 39000, 0, 7800, 1900, "16m 30s", 0],
            [8, 72000, 0, 14000, 3600, "25m", 0],
            [9, 140000, 0, 29000, 7400, "37m 30s", 0],
            [10, 260000, 0, 52000, 13000, "50m", 0],
            [11, 320000, 320000, 65000, 16000, "1h 3m", 0],
            [12, 420000, 420000, 84000, 21000, "1h 15m 30s", 0],
            [13, 590000, 590000, 110000, 29000, "1h 32m", 0],
            [14, 780000, 780000, 150000, 39000, "1h 57m 30s", 0],
            [15, 1100000, 1100000, 230000, 58000, "2h 31m", 0],
            [16, 1400000, 1400000, 290000, 74000, "4h 16m", 0],
            [17, 2300000, 2300000, 460000, 100000, "5h 7m", 0],
            [18, 3100000, 3100000, 620000, 150000, "6h 8m 30s", 0],
            [19, 3900000, 3900000, 780000, 190000, "9h 13m", 0],
            [20, 5300000, 5300000, 1000000, 260000, "11h 31m", 0],
            [21, 6800000, 6800000, 1300000, 340000, "14h 58m 30s", 0],
            [22, 9000000, 9000000, 1800000, 450000, "22h 28m", 0],
            [23, 11000000, 11000000, 2200000, 560000, "1d 7h 27m", 0],
            [24, 15000000, 15000000, 3000000, 750000, "1d 20h 2m", 0],
            [25, 20000000, 20000000, 4000000, 1000000, "2d 13h 39m", 0],
            [26, 26000000, 26000000, 5200000, 1300000, "2d 22h 54m", 0],
            [27, 37000000, 37000000, 7400000, 1800000, "3d 13h 4m", 0],
            [28, 49000000, 49000000, 9900000, 2400000, "4d 1h 50m", 0],
            [29, 61000000, 61000000, 12000000, 3000000, "4d 16h 31m", 0],
            [30, 75000000, 75000000, 15000000, 3700000, "5d 15h 1m", 0],
        ]
    },
    "storehouse": {
        "prereqs_type": "furnace",
        "levels": [
            [1, 60, 0, 0, 0, "2s", 0],
            [2, 90, 0, 0, 0, "9s", 0],
            [3, 400, 0, 0, 0, "45s", 0],
            [4, 900, 0, 180, 0, "2m 15s", 0],
            [5, 3800, 0, 760, 0, "4m 30s", 0],
            [6, 9600, 0, 1900, 480, "9m", 0],
            [7, 34000, 0, 6900, 1700, "18m", 0],
            [8, 63000, 0, 12000, 3100, "27m", 0],
            [9, 130000, 0, 26000, 6500, "40m 30s", 0],
            [10, 230000, 0, 46000, 11000, "54m", 0],
            [11, 290000, 290000, 57000, 14000, "1h 7m 30s", 0],
            [12, 370000, 370000, 74000, 18000, "1h 21m", 0],
            [13, 520000, 520000, 100000, 26000, "1h 39m", 0],
            [14, 690000, 690000, 130000, 34000, "2h 6m", 0],
            [15, 1000000, 1000000, 200000, 51000, "2h 42m", 0],
            [16, 1300000, 1300000, 260000, 65000, "4h 34m", 0],
            [17, 2000000, 2000000, 400000, 100000, "5h 29m", 0],
            [18, 2700000, 2700000, 550000, 130000, "6h 35m", 0],
            [19, 3400000, 3400000, 690000, 170000, "9h 52m 30s", 0],
            [20, 4700000, 4700000, 940000, 230000, "12h 20m 30s", 0],
            [21, 6000000, 6000000, 1200000, 300000, "16h 2m 30s", 0],
            [22, 7900000, 7900000, 1500000, 390000, "1d 4m", 0],
            [23, 9800000, 9800000, 1900000, 490000, "1d 9h 42m", 0],
            [24, 13000000, 13000000, 2600000, 660000, "1d 23h 11m", 0],
            [25, 17000000, 17000000, 3500000, 890000, "2d 18h 3m", 0],
            [26, 23000000, 23000000, 4600000, 1100000, "3d 3h 57m", 0],
            [27, 32000000, 32000000, 6500000, 1600000, "3d 19h 9m", 0],
            [28, 43000000, 43000000, 8700000, 2100000, "4d 8h 49m", 0],
            [29, 54000000, 54000000, 10000000, 2700000, "5d 33m", 0],
            [30, 66000000, 66000000, 13000000, 3300000, "6d 40m", 0],
        ]
    },
}


def build_edges() -> tuple[list, dict]:
    """Build edges from raw data."""
    edges = []
    issues = []

    for building_id, data in BUILDINGS_DATA.items():
        levels = data["levels"]

        for i in range(len(levels) - 1):
            current = levels[i]
            next_level = levels[i + 1]

            lvl_from = current[0]
            lvl_to = next_level[0]

            # Cost comes from CURRENT level (what you pay to upgrade)
            wood = current[1]
            meat = current[2]
            coal = current[3]
            iron = current[4]
            time_str = current[5]

            time_seconds = parse_time(time_str)

            # Build prerequisite - most buildings require Furnace at same level
            prereq = []
            if building_id != "furnace" and lvl_to > 1:
                prereq.append({
                    "system": "buildings",
                    "building_id": "furnace",
                    "level": lvl_to
                })

            edge = {
                "upgrade_id": f"building:{building_id}:L{lvl_from}->L{lvl_to}",
                "from": {"building_id": building_id, "level": lvl_from},
                "to": {"building_id": building_id, "level": lvl_to},
                "cost": {
                    "wood": wood,
                    "meat": meat,
                    "coal": coal,
                    "iron": iron,
                    "fire_crystal": 0,
                    "refined_fire_crystal": 0,
                    "speedups_seconds": 0
                },
                "time_seconds": time_seconds,
                "prereq": prereq,
                "benefit": None,
                "source_ids": ["SRC_BUILDING_CALCULATOR"],
                "evidence": {"sample_key": f"{building_id}_L{lvl_from}_to_L{lvl_to}"},
                "confidence": {"grade": "B", "reason": "calculator output capture"}
            }
            edges.append(edge)

            # Validation: check level increments by 1
            if lvl_to != lvl_from + 1:
                issues.append(f"Non-sequential levels in {building_id}: {lvl_from} -> {lvl_to}")

    return edges, issues


def validate_edges(edges: list) -> dict:
    """Run edge integrity validation."""
    issues = []

    # Check for duplicates
    edge_ids = set()
    for edge in edges:
        if edge["upgrade_id"] in edge_ids:
            issues.append(f"Duplicate edge: {edge['upgrade_id']}")
        edge_ids.add(edge["upgrade_id"])

    # Check all costs are non-negative
    for edge in edges:
        for resource, amount in edge["cost"].items():
            if amount < 0:
                issues.append(f"Negative cost {resource}={amount} in {edge['upgrade_id']}")

    # Check time_seconds is non-negative
    for edge in edges:
        if edge["time_seconds"] < 0:
            issues.append(f"Negative time in {edge['upgrade_id']}")

    return {
        "ok": len(issues) == 0,
        "issues": issues
    }


def main():
    print("Building edges...")
    edges, build_issues = build_edges()

    print("Validating edges...")
    validation = validate_edges(edges)

    # Combine all issues
    all_issues = build_issues + validation["issues"]

    # Build output
    timestamp = datetime.now(timezone.utc).isoformat().replace("+00:00", "Z")

    edges_output = {
        "system": "buildings",
        "unit": "level",
        "currencies": ["wood", "meat", "coal", "iron", "fire_crystal", "refined_fire_crystal", "speedups_seconds"],
        "generated_at": timestamp,
        "notes": [
            "Covers levels 1-30 for key buildings",
            "FC (Fire Crystal) levels not included - see buildings.fc.edges.json when available",
            "Prerequisites simplified to Furnace level requirement"
        ],
        "edges": edges
    }

    # Count edges per building
    building_counts = {}
    for edge in edges:
        bid = edge["from"]["building_id"]
        building_counts[bid] = building_counts.get(bid, 0) + 1

    report = {
        "system": "buildings",
        "generated_at": timestamp,
        "ok": len(all_issues) == 0,
        "total_edges": len(edges),
        "buildings_covered": list(building_counts.keys()),
        "edges_per_building": building_counts,
        "level_range": {"min": 1, "max": 30},
        "issues": all_issues,
        "notes": []
    }

    # Save files
    print(f"Saving edges to {EDGES_FILE}...")
    EDGES_FILE.parent.mkdir(parents=True, exist_ok=True)
    with open(EDGES_FILE, 'w', encoding='utf-8') as f:
        json.dump(edges_output, f, indent=2)

    print(f"Saving report to {REPORT_FILE}...")
    with open(REPORT_FILE, 'w', encoding='utf-8') as f:
        json.dump(report, f, indent=2)

    # Print summary
    print("\n" + "="*60)
    print("BUILDINGS BUILD COMPLETE")
    print("="*60)
    print(f"Total edges: {report['total_edges']}")
    print(f"Buildings covered: {len(building_counts)}")
    for bid, count in building_counts.items():
        print(f"  - {bid}: {count} edges")
    print(f"Status: {'OK' if report['ok'] else 'FAILED'}")

    if all_issues:
        print(f"Issues: {len(all_issues)}")
        for issue in all_issues[:5]:
            print(f"  - {issue}")

    print("="*60)

    return report["ok"]


if __name__ == "__main__":
    success = main()
    exit(0 if success else 1)
